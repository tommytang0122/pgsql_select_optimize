# 數據載入流程 (Data Loading Progress)

## 流程圖

```
使用者點擊「載入數據」按鈕
          │
          ▼
┌─────────────────────────────────────────────────────────────────┐
│                        前端 (app.js)                             │
│                                                                  │
│  1. 顯示載入動畫                                                  │
│  2. 根據 CONFIG.USE_BATCH_LOADING 決定載入模式:                   │
│                                                                  │
│     ┌─────────────────────┐    ┌─────────────────────────────┐  │
│     │ 一次載入             │    │ 分批載入 (目前設定)          │  │
│     │                     │    │                             │  │
│     │ fetch('/data/all')  │ 或 │ 順序/並行 (USE_PARALLEL)     │  │
│     │                     │    │   fetch('/data?limit=X')    │  │
│     └─────────────────────┘    └─────────────────────────────┘  │
│                                                                  │
└──────────────────────────────┬──────────────────────────────────┘
                               │ HTTP 請求
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                      後端 (main.py / FastAPI)                    │
│                                                                  │
│  1. 接收請求                                                      │
│  2. 根據 USE_CONNECTION_POOL 決定連線方式:                        │
│  3. 根據 USE_GZIP 決定是否壓縮回應                                 │
│                                                                  │
│     ┌───────────────────┐    ┌───────────────────────┐          │
│     │ 連線池模式         │    │ 直接連線模式 (目前)    │          │
│     │ 從池中取出連線     │ 或 │ psycopg2.connect()    │          │
│     └───────────────────┘    └───────────────────────┘          │
│                                                                  │
│  4. 執行 SQL: SELECT * FROM data_100k ORDER BY id                │
│  5. 回傳 JSON 數據 (可選 GZip 壓縮)                               │
│                                                                  │
└──────────────────────────────┬──────────────────────────────────┘
                               │ SQL 查詢
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    PostgreSQL (Docker 容器)                      │
│                                                                  │
│  • 資料表: data_100k                                             │
│  • 總筆數: 100,000 筆                                            │
│  • 欄位: id + a-z (27 欄)                                        │
│                                                                  │
└──────────────────────────────┬──────────────────────────────────┘
                               │ JSON 回傳
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                     前端渲染 (虛擬列表)                           │
│                                                                  │
│  1. 儲存數據到 allData 陣列                                       │
│  2. 設置 tbody 總高度 (100,000 × 40px)                           │
│  3. 只渲染可視區域的 ~35 行                                       │
│  4. 滾動時動態更新渲染的行                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 設定檔位置

### 後端設定 (main.py)

| 設定 | 行號 | 目前值 | 說明 |
|------|------|--------|------|
| `USE_GZIP` | 22 | `False` | GZip 壓縮開關 |
| `GZIP_MIN_SIZE` | 23 | `500` | 最小壓縮大小 |
| `USE_CONNECTION_POOL` | 59 | `False` | 連線池開關 |
| `POOL_MIN_CONN` | 60 | `2` | 最小連線數 |
| `POOL_MAX_CONN` | 61 | `10` | 最大連線數 |

### 前端設定 (static/app.js)

| 設定 | 行號 | 目前值 | 說明 |
|------|------|--------|------|
| `USE_BATCH_LOADING` | 12 | `true` | 分批載入開關 |
| `USE_PARALLEL` | 13 | `false` | 並行請求開關 |
| `BATCH_SIZE` | 14 | `10000` | 每批筆數 (10次) |
| `PARALLEL_LIMIT` | 15 | `5` | 並行數量上限 |

## 載入時間基準

| 筆數 | 一次載入 | 分批載入 (10批) |
|------|---------|----------------|
| 10,000 | ~300ms | ~400ms |
| 50,000 | ~1.5s | ~2s |
| 100,000 | ~3s | ~4s |

## API 端點

| 端點 | 用途 |
|------|------|
| `GET /data/all` | 一次載入全部數據 |
| `GET /data?limit=N&offset=M` | 分頁載入 |
| `GET /data/count` | 取得總筆數 |
| `GET /api/pool/status` | 查看連線池狀態 |
